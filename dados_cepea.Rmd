---
title: "Dados CEPEA"
author: 
- Lucca Simeoni Pavan \hspace{1cm} João Carlos de Carvalho
header-includes:
   - \setlength\parindent{24pt}
   - \usepackage[english, brazil]{babel}
   - \usepackage[utf8]{inputenc}
   - \usepackage{longtable}
   - \usepackage{booktabs}
date: \today
output: 
  pdf_document: 
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: no
bibliography: bib_artigo_macroeconometria.bib
---

```{r setup, include=TRUE, tidy = TRUE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE, warning = FALSE, message = FALSE, error = FALSE, tidy = TRUE, tidy.opts = list(width.cutoff = 70))
```

```{r}
libraries = c("car",
              "abind",
              "quantmod",
              "zoo", 
              "Epi",
              "tseries",
              "urca",
              "vars",
              "tsDyn",
              "stats", 
              "fGarch",
              "np",
              "corpcor",
              "FinTS",
              "rugarch", 
              "rmgarch",
              "Rcpp",
              "truncnorm",
              "Kendall",
              "sm",
              "ccgarch",
              "boot",
              "moments")
```

Os dados são de peridiocidade diária e são disponibilizados pela [CEPEA/EXALQ](http://www.cepea.esalq.usp.br/br/consultas-ao-banco-de-dados-do-site.aspx) e se referem ao período de  a 23/01/2017. O dados para o etanol correspondem ao Indicador Diário do Etanol Hidratado ESALQ/BM&FBovespa Posto Paulínia (SP). Para o açúcar os dados são o Indicado Açúcar Criatal CEPEA/EXALQ - São Paulo por saca de 50 quilos. Para o soja os dados são o Indicador Soja CEPEA/EXALQ - Paraná por saca de 60 quilos. Ocorreram 15 valores faltante para o soja durante o período que foram interpolados pelo método *spline* conforme indicado por @zeileis_zoo:_2005.

```{r}
library(dplyr)
acucar <- read.table("acucar.txt", sep = "\t", dec = ",", header = TRUE, encoding = "ANSI")
Rdate <- strptime(as.character(acucar$Data),"%d/%m/%Y")
acucar <- data.frame(Rdate, acucar) %>% mutate(Rdate = as.Date(Rdate)) %>% as.data.frame()
```

```{r}
soja <- read.table("soja.txt", sep = "\t", dec = ",", header = TRUE, encoding = "ANSI")
Rdate <- strptime(as.character(soja$Data),"%d/%m/%Y")
soja <- data.frame(Rdate, soja) %>% mutate(Rdate = as.Date(Rdate)) %>% as.data.frame()
```

```{r}
# Nos dados para o etanol os pontos (separadores de milhas) foram removidos no excel
etanol <- read.table("etanol.txt", sep = "\t", dec = ",", header = TRUE, encoding = "ANSI")
Rdate <- strptime(as.character(etanol$Data),"%d/%m/%Y")
etanol <- data.frame(Rdate, etanol) %>% mutate(Rdate = as.Date(Rdate)) %>% as.data.frame()
```
```{r}
library(zoo)
library(knitr)
dados_cepea <- merge(soja, etanol, by.x = "Rdate", by.y = "Rdate") %>% merge(acucar, by.x = "Rdate", by.y = "Rdate", all.x = TRUE) %>% select(Rdate = Rdate, acucar = À.vista.R..x, etanol = À.vista.R..y,  soja = À.vista.R. ) %>% ts() %>% na.spline() %>% as.data.frame() %>% mutate(Data = as.Date(Rdate))
kable(summary(dados_cepea[,-1]), caption = "Resumo das séries de preços", format = "latex", booktabs = TRUE, longtable = TRUE, digits = 2)
save(dados_cepea, file = "dados_cepea.Rda")
```

Para vizualização dos dados foi plotado na Figura 1 os gráficos do log da série de preços e do log da série de preços deflacionada. Optou-se pela apresentação na forma de logarítmo devido a diferença de escala entre o preço do etanol e dos preços da soja e açúcar. Na Figura 2 consta a volatilidade $v_i$ do etanol, açúcar e soja medida pela seguinte fórmula:

$$v_i = \bigg(\Delta \log p_{i,t}\bigg)^2.$$
Em que $p_{i,t}$ é o preço da *commodity* $i$ e $i = \text{etanol, açúcar ou soja}$. Percebe-se que a volatilidade do preço do açúcar é bem mais intensa e com maior amplitude se comparadas às volatilidades do preço do soja e do preço do  etanol. Entretanto, conforme @lopez_cabrera_volatility_2016 é característico das séries de preços de *commodities* serem cointegradas e uma medida de volatilidade que leve em conta esta característica dos dados se torna mais apropriada. Para isso pode-se modelar a média da série de preços por meio e um modelo de correção de erros (VECM, sigla em inglês) e então filtrar a série de preços do co-movimento de suas médias condicionais.

```{r grafico1, fig.height= 6, fig.width=14, fig.cap = "Logarítimo dos preços diários e preço diário deflacionado pelo Ìndice de Preço do Produtor (IPP) para o etanol, açúcar e soja"}
par(mfrow = c(1, 2))
dados_cepea <- mutate(dados_cepea, etanol=log(etanol), soja = log(soja), acucar = log(acucar))
plot(dados_cepea$Data,
     dados_cepea$etanol,
     cex.axis = 1.2,
     cex.lab  = 1.2, 
     type     = "l",
     lwd      = 3,
     xlab     = "Data",
     ylab     = "log(Preço)", 
     ylim     = c(2, 8))

lines(dados_cepea$Data,
      dados_cepea$acucar,
      type = "l",
      lwd  = 3, 
      lty  = 2)

lines(dados_cepea$Data,
      dados_cepea$soja,
      type = "l",
      lwd  = 4, 
      lty  = 3)

legend("bottomleft",
       c("Etanol", "Açúcar", "Soja"), 
       y.intersp = 0.5,
       cex       =1.5,
       lty       = c(1, 2, 3), 
       lwd       = 3,
       horiz = TRUE,
       bty       = "n")

load("dados_cepea_deflacionado.rda")

plot(dados_cepea_deflacionado$Data,
     dados_cepea_deflacionado$etanol,
     cex.axis = 1.2,
     cex.lab  = 1.2, 
     type     = "l",
     lwd      = 3,
     xlab     = "Data",
     ylab     = "log(Preço) deflacionado", 
     ylim     = c(2, 8))

lines(dados_cepea_deflacionado$Data,
      dados_cepea_deflacionado$acucar,
      type = "l",
      lwd  = 3, 
      lty  = 2)

lines(dados_cepea_deflacionado$Data,
      dados_cepea_deflacionado$soja,
      type = "l",
      lwd  = 4, 
      lty  = 3)

legend("bottomleft",
       c("Etanol", "Açúcar", "Soja"), 
       y.intersp = 0.5,
       cex       =1.5,
       lty       = c(1, 2, 3), 
       lwd       = 3,
       horiz = TRUE,
       bty       = "n")
```

```{r grafico2, fig.height= 8, fig.width=18, fig.cap='Volatilidade medida pela diferença do logarítimo do preço ao quadrado para a etanol, açúcar e soja'}
volat_cepea <- mutate(dados_cepea_deflacionado, Data = Data, etanol = (etanol-lag(etanol))^2, soja = (soja-lag(soja))^2, acucar = (acucar-lag(acucar))^2)

par(mfrow = c(1,3))
plot(volat_cepea$Data,
     volat_cepea$etanol,
     cex.axis = 1.2,
     cex.lab  = 1.2, 
     type     = "l",
     lwd      = 3,
     lty  = 3,
     xlab     = "Data",
     ylab     = "Volatilidade")

legend("topright",
       "Etanol", 
       y.intersp = 0.5,
       cex       =1.5,
       lty       =  3, 
       lwd       = 3,
       horiz = TRUE,
       bty       = "n") 

plot(volat_cepea$Data,
     volat_cepea$acucar,
     cex.axis = 1.2,
     cex.lab  = 1.2, 
     type     = "l",
     lwd      = 3,
     lty  = 3,
     xlab     = "Data",
     ylab     = "log(Preço)")

legend("topright",
       "Açúcar", 
       y.intersp = 0.5,
       cex       =1.5,
       lty       =3, 
       lwd       = 3,
       horiz = TRUE,
       bty       = "n")

plot(volat_cepea$Data,
     volat_cepea$soja,
     cex.axis = 1.2,
     cex.lab  = 1.2, 
     type     = "l",
     lwd      = 3,
     lty  = 3,
     xlab     = "Data",
     ylab     = "log(Preço)")


legend("topright",
       "Soja", 
       y.intersp = 0.5,
       cex       =1.5,
       lty       =  3, 
       lwd       = 3,
       horiz = TRUE,
       bty       = "n")
```

```{r tabela2}
library(moments)
library(FinTS)
ldif_cepea <- mutate(dados_cepea_deflacionado, Data = Data, etanol = (etanol-lag(etanol)), soja = (soja-lag(soja)), acucar = (acucar-lag(acucar)))
print("Mean")
print(colMeans(dados_cepea_deflacionado[, -1]))
print("St.D.")
print(sqrt(var(dados_cepea_deflacionado[, -1])))
print("Corr.")
print(cor(dados_cepea_deflacionado[, -1]))


print("Skewness")
print(c(skewness(ldif_cepea[-1, 2]),
        skewness(ldif_cepea[-1, 3]),
        skewness(ldif_cepea[-1, 4])))

print("Kurtosis")
print(c(kurtosis(ldif_cepea[-1, 2]),
        kurtosis(ldif_cepea[-1, 3]),
        kurtosis(ldif_cepea[-1, 4])))

print("Box Ljung (residuals)")
print(c(Box.test(ldif_cepea[-1, 2], lag = 20, type = "Ljung")$p.value, 
        Box.test(ldif_cepea[-1, 3], lag = 20, type = "Ljung")$p.value, 
        Box.test(ldif_cepea[-1, 4], lag = 20, type = "Ljung")$p.value))

print("Box-Ljung (squared residuals)")
print(c(Box.test(ldif_cepea[-1, 2]^2, lag = 20, type = "Ljung")$p.value, 
        Box.test(ldif_cepea[-1, 3]^2, lag = 20, type = "Ljung")$p.value, 
        Box.test(ldif_cepea[-1, 4]^2, lag = 20, type = "Ljung")$p.value))

print("ARCH")
print(c(ArchTest(ldif_cepea[-1, 2], lags = 5)$p.value,
        ArchTest(ldif_cepea[-1, 3], lags = 5)$p.value,
        ArchTest(ldif_cepea[-1, 4], lags = 5)$p.value))

print("Shapiro-Wilk")
print(c(shapiro.test(ldif_cepea[-1, 2])$p.value,
        shapiro.test(ldif_cepea[-1, 3])$p.value,
        shapiro.test(ldif_cepea[-1, 4])$p.value))

```




```{r ADF e KPSS nivel}
library(BMR)
stat_cepea <- stationarity(dados_cepea_deflacionado[,-1], 4, 8, print = FALSE)
library(knitr)
kable(stat_cepea$KPSS, caption = "Teste KPSS preço em nível", format = "latex", booktabs = TRUE,longtable = TRUE, digits = 2)
kable(stat_cepea$ADF, caption = "Teste ADF preço em nível", format = "latex", booktabs = TRUE,longtable = TRUE, digits = 2)
kable(stat_cepea$ADFLags, caption = "Defasagens do teste ADF", format = "latex", booktabs = TRUE,longtable = TRUE, digits = 2)
```

```{r pp test nivel}
library(tseries)
pp.test(dados_cepea_deflacionado[,"etanol"])
pp.test(dados_cepea_deflacionado[,"acucar"])
pp.test(dados_cepea_deflacionado[,"soja"])

```

```{r ADF e KPSS logdif}
library(BMR)
stat_cepea <- stationarity(ldif_cepea[-1,-1], 4, 8, print = FALSE)
library(knitr)
kable(stat_cepea$KPSS, caption = "Teste KPSS retorno", format = "latex", booktabs = TRUE,longtable = TRUE, digits = 2)
kable(stat_cepea$ADF, caption = "Teste ADF retorno", format = "latex", booktabs = TRUE,longtable = TRUE, digits = 2)
kable(stat_cepea$ADFLags, caption = "Defasagens do teste ADF", format = "latex", booktabs = TRUE,longtable = TRUE, digits = 2)
```

```{r pp test logdif}
library(tseries)
pp.test(ldif_cepea[-1,"etanol"])
pp.test(ldif_cepea[-1,"acucar"])
pp.test(ldif_cepea[-1,"soja"])

```



\pagebreak

# Referências {-}
\setlength{\parindent}{0in}
